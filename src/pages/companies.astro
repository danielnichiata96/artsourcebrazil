---
import { Image } from 'astro:assets';
import { getJobs } from '../lib/getJobs';
import Layout from '../layouts/Layout.astro';
import Button from '../components/ui/Button.astro';
import Badge from '../components/ui/Badge.astro';
import Breadcrumb from '../components/ui/Breadcrumb.astro';
import Card from '../components/ui/Card.astro';
import Link from '../components/ui/Link.astro';
import { slugify } from '../lib/jobs';
import type { Job } from '../lib/jobs';

const allJobs = await getJobs();

// Group jobs by company
const companiesMap = new Map<
  string,
  { name: string; logo: string; jobCount: number; categories: Set<string> }
>();

allJobs.forEach((job) => {
  const slug = slugify(job.companyName);
  if (!companiesMap.has(slug)) {
    companiesMap.set(slug, {
      name: job.companyName,
      logo: job.companyLogo,
      jobCount: 0,
      categories: new Set(),
    });
  }
  const company = companiesMap.get(slug)!;
  company.jobCount++;
  company.categories.add(job.category);
});

// Convert to array and sort by job count (descending)
const companies = Array.from(companiesMap.entries())
  .map(([slug, company]) => ({
    slug,
    ...company,
    categories: Array.from(company.categories),
  }))
  .sort((a, b) => b.jobCount - a.jobCount);

const site = Astro.site ?? new URL('http://localhost:4321');

// SEO
const seo = {
  title: 'Empresas Contratando no Brasil | Art Source Brazil',
  description: `Navegue por ${companies.length} empresas contratando profissionais criativos remotos no Brasil. Encontre oportunidades em Game Dev, 3D & Animação, Design UI/UX e muito mais.`,
  image: '/images/og-default.svg',
};

// BreadcrumbList JSON-LD
const breadcrumbs = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Início',
      item: new URL('/', site).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: 'Empresas',
      item: new URL('/companies', site).href,
    },
  ],
};
---

<Layout seo={seo}>
  <Fragment slot="head">
    <!-- Breadcrumbs JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbs)} />
  </Fragment>

  <main class="container mx-auto px-container py-section">
    <!-- Breadcrumbs -->
    <Breadcrumb
      class="mb-6"
      items={[{ label: 'Início', href: '/' }, { label: 'Empresas' }]}
    />

    <!-- Header -->
    <header class="mb-16 text-center">
      <div class="inline-flex items-center gap-2 border-2 border-ink bg-white px-3 py-1 mb-6 shadow-hard-sm">
          <span class="w-2 h-2 rounded-full bg-brazil-blue animate-pulse"></span>
          <span class="text-xs font-bold uppercase tracking-widest">Diretório Oficial</span>
      </div>
      <h1 class="mb-6 font-display text-5xl md:text-6xl font-bold tracking-tight text-ink">
        Empresas <span class="text-transparent bg-clip-text bg-gradient-to-r from-brazil-green to-brazil-blue">Contratando</span>
      </h1>
      <p class="mx-auto max-w-2xl text-lg font-medium leading-relaxed text-neutral-600">
        Explore {companies.length} empresas contratando ativamente profissionais criativos remotos
        no Brasil. De Game Dev a Design UI/UX, encontre sua próxima oportunidade.
      </p>
    </header>

    <!-- Companies Grid -->
    <section class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {
        companies.map((company) => (
          <Link href={`/company/${company.slug}`} class="group block h-full">
            <div class="flex h-full flex-col border-2 border-ink bg-white p-6 shadow-hard transition-all duration-200 hover:shadow-none hover:translate-x-[3px] hover:translate-y-[3px]">
              <!-- Company Logo -->
              <div class="mb-6 flex items-center justify-center">
                <div class="h-24 w-24 flex items-center justify-center rounded-none border-2 border-ink bg-white p-2 shadow-hard-sm">
                  <Image
                    src={company.logo}
                    alt={`${company.name} logo`}
                    width={80}
                    height={80}
                    loading="lazy"
                    class="h-full w-full object-contain"
                  />
                </div>
              </div>

              <!-- Company Name -->
              <h2 class="mb-2 text-center font-display text-2xl font-bold text-ink transition-colors group-hover:text-primary">
                {company.name}
              </h2>

              <!-- Job Count -->
              <p class="mb-4 text-center text-sm font-bold uppercase tracking-wider text-neutral-500">
                {company.jobCount} vaga{company.jobCount > 1 ? 's' : ''}
              </p>

              <!-- Categories -->
              <div class="mt-auto">
                <div class="flex flex-wrap justify-center gap-2">
                  {company.categories.slice(0, 2).map((category) => (
                    <span class="border border-ink bg-neutral-100 px-2 py-1 text-xs font-bold uppercase text-ink">
                      {category}
                    </span>
                  ))}
                  {company.categories.length > 2 && (
                    <span class="border border-ink bg-white px-2 py-1 text-xs font-bold uppercase text-neutral-500">
                      +{company.categories.length - 2}
                    </span>
                  )}
                </div>
              </div>

              <!-- View Jobs Arrow -->
              <div class="mt-6 flex justify-center opacity-0 transition-opacity group-hover:opacity-100">
                <span class="font-bold text-primary">Ver vagas →</span>
              </div>
            </div>
          </Link>
        ))
      }
    </section>

    <!-- CTA -->
    <div class="mt-12 text-center">
      <p class="mb-4 text-neutral-600">Não vê sua empresa aqui?</p>
      <Button href="/post-a-job" size="lg">
        Postar uma Vaga →
      </Button>
    </div>
  </main>
</Layout>
