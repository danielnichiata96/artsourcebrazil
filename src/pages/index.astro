---
import jobs from '../data/jobs.json';
import JobCard from '../components/JobCard.astro';
import FiltersSidebar from '../components/FiltersSidebar.astro';
import Layout from '../layouts/Layout.astro';
import Badge from '../components/ui/Badge.astro';
import '../styles/global.css';
import { sortJobsByDateDesc, collectFacets, slugify } from '../lib/jobs';

import type { Job } from '../lib/jobs';

// Use shared helpers so behavior is covered by unit tests
const sortedJobs = sortJobsByDateDesc(jobs as Job[]);
const { categories, tags } = collectFacets(jobs as Job[]);

// SEO helpers
const site = Astro.site ?? new URL('http://localhost:4321');
const seo = {
  title: 'ArtSource Brazil — Remote Creative Jobs',
  description:
    'Niche job board for Brazil-based creative talent: Game Dev, 3D & Animation, and UI/UX Design. Find curated remote roles from international studios.',
  image: '/images/artsource-brazil-logo.svg',
};

// JSON-LD: one JobPosting per job
const jobPostings = sortedJobs.map((j) => ({
  '@context': 'https://schema.org',
  '@type': 'JobPosting',
  title: j.jobTitle,
  datePosted: j.postedDate,
  employmentType: 'CONTRACT',
  jobLocationType: 'TELECOMMUTE',
  hiringOrganization: {
    '@type': 'Organization',
    name: j.companyName,
    logo: new URL(j.companyLogo, site).href,
  },
  description: `${j.category} — ${j.tags.join(', ')}`,
  directApply: true,
  applicationContact: undefined,
  applicantLocationRequirements: {
    '@type': 'Country',
    name: 'Brazil',
  },
  identifier: {
    '@type': 'PropertyValue',
    name: j.companyName,
    value: j.id,
  },
  url: j.applyLink,
}));
---

<Layout seo={seo}>
  <Fragment slot="head">
    <!-- JSON-LD: JobPostings -->
    <script type="application/ld+json" set:html={JSON.stringify(jobPostings)} />
  </Fragment>

  <!-- Layout with Sidebar -->
  <div class="flex min-h-screen">
    <!-- Filters Sidebar -->
    <FiltersSidebar categories={categories} />

    <!-- Main Content -->
    <main class="flex-1 min-w-0 lg:ml-80">
      <div class="container mx-auto px-container py-section-sm">
        <!-- Hero section -->
        <div class="mb-12 text-center animate-fade-in-up">
          <h1 class="mb-4 font-serif text-5xl font-bold tracking-tight text-neutral-900 sm:text-6xl">
            Find Your Next Creative Role
          </h1>
          <p class="mx-auto max-w-2xl text-lg text-neutral-700">
            Remote opportunities for Brazilian artists, designers, and game developers
          </p>
        </div>

        <!-- SEO-friendly links to category pages (hidden, for crawlers) -->
        <nav class="sr-only" aria-label="Browse by category">
          {
            categories.map((cat) => {
              const slug = slugify(cat);
              return (
                <a href={`/category/${slug}`}>
                  {cat} jobs
                </a>
              );
            })
          }
        </nav>

        <!-- Job Cards Results -->
        <div class="space-y-6 animate-fade-in" style="animation-delay: 0.2s; animation-fill-mode: both;" data-jobs>
          {
            sortedJobs.map((job: Job) => (
              <JobCard
                job={job}
                data-testid="job-card"
                data-category={job.category}
                data-tags={job.tags.join(' ')}
                data-text={`${job.jobTitle} ${job.companyName}`}
              />
            ))
          }
        </div>
      </div>
    </main>
  </div>
</Layout>

<script>
  import { parseURLParams, validateFilterUpdate, type FilterState } from '../lib/validation/filter-schema';

  // Global filter orchestrator: single source of truth for filters
  (function () {
    // Parse and validate URL params safely
    const params = new URLSearchParams(location.search);
    const state: FilterState = parseURLParams(params);

    function getItems(): HTMLElement[] {
      try {
        const container = document.querySelector('[data-jobs]');
        if (!container) {
          console.warn('[FilterOrchestrator] Jobs container not found');
          return [];
        }
        return Array.from(container.children) as HTMLElement[];
      } catch (error) {
        console.error('[FilterOrchestrator] Error getting items:', error);
        return [];
      }
    }

    function includesAll(tagString: string, arr: string[]): boolean {
      if (!arr || arr.length === 0) return true;
      const normalizedTags = (tagString || '').toLowerCase();
      const set = new Set(normalizedTags.split(/\s+/).filter(Boolean));
      return arr.every((v) => set.has(String(v).toLowerCase()));
    }

    function apply(): void {
      try {
        const items = getItems();
        if (items.length === 0) {
          console.warn('[FilterOrchestrator] No items to filter');
          return;
        }

        const qLower = (state.search || '').toLowerCase();

        items.forEach((el) => {
          if (!el) return;

          const tagsStr = (el.getAttribute('data-tags') || '').toLowerCase();
          const text = (el.getAttribute('data-text') || '').toLowerCase();
          const jobCategory = el.getAttribute('data-category') || '';

          let show = true;
          
          // Category filter
          if (state.category && state.category !== 'all') {
            show = jobCategory === state.category;
          }
          
          // Search filter
          if (show && qLower) {
            show = text.includes(qLower) || tagsStr.includes(qLower);
          }

          // Advanced filters: match by tags
          if (show && !includesAll(tagsStr, state.level)) show = false;
          if (show && !includesAll(tagsStr, state.tools)) show = false;
          // Contract/Location could be supported later when data is available

          el.classList.toggle('hidden', !show);
        });

        // Sync URL with current state
        const next = new URLSearchParams();
        if (state.search) next.set('q', state.search);
        if (state.category && state.category !== 'all') next.set('category', state.category);
        if (state.level?.length) next.set('level', state.level.join(','));
        if (state.tools?.length) next.set('tools', state.tools.join(','));
        if (state.contract?.length) next.set('contract', state.contract.join(','));
        if (state.location?.length) next.set('location', state.location.join(','));
        
        const url = `${location.pathname}${next.toString() ? `?${next.toString()}` : ''}`;
        history.replaceState({}, '', url);

        // Notify listeners
        window.dispatchEvent(new CustomEvent('jobfilters:applied', { detail: { ...state } }));
      } catch (error) {
        console.error('[FilterOrchestrator] Error applying filters:', error);
      }
    }

    // Listen for filter changes from components
    window.addEventListener('jobfilters:change', (ev: Event) => {
      try {
        const ce = ev as CustomEvent<Partial<FilterState>>;
        const detail = ce.detail || {};
        
        // Validate the incoming data
        const validatedData = validateFilterUpdate(detail);
        if (!validatedData) {
          console.warn('[FilterOrchestrator] Invalid filter data received');
          return;
        }
        
        Object.assign(state, validatedData);
        apply();
      } catch (error) {
        console.error('[FilterOrchestrator] Error handling filter change:', error);
      }
    });

    // Initial apply after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', apply);
    } else {
      apply();
    }
  })();
</script>
