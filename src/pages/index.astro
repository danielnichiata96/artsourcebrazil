---
import Layout from '../layouts/Layout.astro';
import JobCard from '../components/JobCard.astro';
import { getJobs } from '../lib/getJobs';
import type { Job } from '../lib/jobs';
import { sortJobsByDateDesc } from '../lib/jobs';
import { getMessages } from '../lib/i18n';

// Fetch jobs from Supabase at build time
const jobs: Job[] = await getJobs();
const sortedJobs = sortJobsByDateDesc(jobs);

// Get Portuguese messages
const messages = getMessages('pt-BR');
const { hero, seo: seoMessages, filters, results } = messages;

const seo = {
  title: seoMessages.home.title,
  description: seoMessages.home.description,
};
---

<Layout seo={seo}>
    <main class="flex-1 relative">
        
        <!-- Hero Section -->
        <section class="relative border-b-2 border-ink bg-paper overflow-hidden py-20 lg:py-28">
            <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 relative z-10">
                <div class="max-w-4xl">
                    <!-- Animated Badge -->
                    <div class="inline-flex items-center gap-2 border-2 border-ink bg-white px-3 py-1 mb-8 shadow-hard-sm animate-fade-in-up">
                        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                        <span class="text-xs font-bold uppercase tracking-widest">{hero.badge}</span>
                    </div>

                    <h1 class="font-display text-6xl sm:text-8xl font-bold leading-[0.9] mb-8 tracking-tighter animate-fade-in-up delay-100">
                        {hero.titleLine1} <br/>
                        <span class="text-transparent bg-clip-text bg-gradient-to-r from-accent-purple to-accent-teal">{hero.titleLine2}</span> <br/>
                        {hero.titleLine3}
                    </h1>
                    
                    <div class="flex flex-col md:flex-row gap-8 items-start md:items-center animate-fade-in-up delay-200">
                        <p class="text-xl text-stone-600 font-medium max-w-lg leading-relaxed border-l-4 border-accent-lime pl-6" set:html={hero.description}></p>

                        <!-- Search Input -->
                        <div class="relative w-full md:w-auto flex-1 max-w-md">
                            <div class="flex shadow-hard bg-white border-2 border-ink group focus-within:shadow-hard-lg transition-shadow">
                                <input
                                    type="text"
                                    id="search-input"
                                    class="w-full bg-transparent border-none py-4 pl-4 text-lg font-bold placeholder:text-stone-300 focus:ring-0 uppercase tracking-wide"
                                    placeholder={filters.searchPlaceholder}
                                    aria-label={filters.searchLabel}
                                />
                                <button class="bg-accent-lime text-ink px-6 border-l-2 border-ink hover:bg-accent-teal transition-colors">
                                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Abstract Shape decoration -->
            <div class="absolute top-20 right-[-5%] w-[400px] h-[400px] bg-accent-purple/20 rounded-full blur-3xl mix-blend-multiply pointer-events-none"></div>
            <div class="absolute bottom-[-10%] left-[-5%] w-[300px] h-[300px] bg-accent-lime/20 rounded-full blur-3xl mix-blend-multiply pointer-events-none"></div>
        </section>

        <!-- Main Content Area -->
        <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 relative">
            <div class="flex flex-col lg:flex-row gap-12">
                
                <!-- Desktop Sidebar -->
                <aside id="filters-sidebar" class="hidden lg:block w-72 flex-shrink-0">
                    <div class="sticky top-28 space-y-10">
                        <!-- Categories -->
                        <div class="border-2 border-ink bg-white p-6 shadow-hard-sm transform rotate-1 hover:rotate-0 transition-transform duration-300">
                            <h3 class="font-display text-lg font-bold uppercase tracking-wide mb-5 border-b-2 border-ink pb-2 inline-block">
                                {filters.discipline}
                            </h3>
                            <div class="space-y-3" id="category-filters">
                                <label class="flex items-center gap-3 cursor-pointer group hover:translate-x-1 transition-transform">
                                    <input type="radio" name="category-filter" value="all" checked class="studio-checkbox" />
                                    <span class="font-bold text-sm uppercase group-hover:text-accent-purple transition-colors">{filters.allCategories}</span>
                                </label>
                                <!-- JS Injected -->
                            </div>
                        </div>

                        <!-- Tags -->
                        <div>
                            <h3 class="font-display text-lg font-bold uppercase tracking-wide mb-4 flex items-center gap-2">
                                <span class="w-2 h-2 bg-accent-lime border border-ink"></span> {hero.stats.skills.label}
                            </h3>
                            <div class="flex flex-wrap gap-2" id="tag-filters">
                                <!-- JS Injected -->
                            </div>
                        </div>

                        <!-- Ad Box -->
                        <div class="bg-ink text-paper p-6 border-2 border-ink shadow-hard text-center">
                            <p class="font-display font-bold text-xl mb-2">{filters.hiringTitle}</p>
                            <p class="text-sm text-stone-400 mb-4">{filters.hiringSubtitle}</p>
                            <button class="w-full bg-paper text-ink font-bold uppercase py-2 hover:bg-accent-lime transition-colors">{filters.postNow}</button>
                        </div>
                    </div>
                </aside>

                <!-- Feed -->
                <div class="flex-1">
                    <!-- Feed Header -->
                    <div class="mb-8 flex items-center justify-between border-b-2 border-stone-300 pb-4 sticky top-20 bg-paper/95 backdrop-blur z-20 pt-4 lg:pt-0">
                        <h2 class="font-display text-3xl font-bold uppercase">
                            {hero.sectionTitle} <span class="ml-2 bg-accent-lime border border-ink text-ink text-lg px-2 py-0.5 align-middle rounded-none shadow-[2px_2px_0px_0px_#000]" id="job-count">0</span>
                        </h2>
                        
                        <!-- Mobile Filter Trigger -->
                        <button id="mobile-filter-btn" class="lg:hidden flex items-center gap-2 font-bold uppercase tracking-wide border-2 border-ink px-4 py-2 bg-white hover:bg-ink hover:text-white transition-colors shadow-hard-sm">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" /></svg>
                            {filters.toggle}
                        </button>
                    </div>

                    <!-- Job Grid -->
                    <div id="job-list" class="grid gap-6">
                        {sortedJobs.map(job => (
                            <JobCard {job} />
                        ))}
                    </div>
                    
                    <!-- Empty State -->
                    <div id="empty-state" class="hidden py-24 text-center border-2 border-dashed border-ink bg-white/50">
                        <div class="font-display text-6xl mb-4 grayscale">ðŸ’€</div>
                        <h3 class="font-display text-2xl font-bold mb-2">{hero.emptyStateTitle}</h3>
                        <p class="text-stone-500 mb-6">{results.emptyList}</p>
                        <button id="clear-filters" class="border-2 border-ink bg-accent-lime px-6 py-2 font-bold uppercase shadow-hard hover:translate-x-[2px] hover:translate-y-[2px] hover:shadow-none transition-all">
                            {hero.emptyStateReset}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
</Layout>

<script define:vars={{ jobsData: sortedJobs, messages }}>
// --- 2. HELPERS ---
const timeAgo = (dateStr) => {
    const days = Math.floor((new Date() - new Date(dateStr)) / (86400000));
    if (days === 0) return messages.hero.timeAgo.today;
    if (days === 1) return messages.hero.timeAgo.yesterday;
    return messages.hero.timeAgo.daysAgo.replace('{days}', days);
};

const formatSalary = (s) => {
    if (!s || (!s.min && !s.max)) return null;
    const fmt = (n) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: s.currency, maximumSignificantDigits: 3 }).format(n);
    if (s.min && s.max) return `${fmt(s.min)}-${fmt(s.max)}`;
    return s.min ? `>${fmt(s.min)}` : `<${fmt(s.max)}`;
};

const getLocationLabel = (scope) => {
    const map = {
        'remote-brazil': messages.hero.location.brazilOnly,
        'remote-latam': messages.hero.location.latamRemote,
        'remote-worldwide': messages.hero.location.global,
        'hybrid': messages.hero.location.hybrid,
        'onsite': messages.hero.location.onsite
    };
    return map[scope] || messages.hero.location.remote;
};

// --- 3. RENDERING ---

function renderFilters() {
    const categories = [...new Set(jobsData.map(j => j.category))].sort();
    const allTags = jobsData.flatMap(j => j.tags);
    const popularTags = [...new Set(allTags)].sort((a,b) => allTags.filter(t=>t===b).length - allTags.filter(t=>t===a).length).slice(0,10);

    const renderCats = (containerId) => {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = `
            <label class="flex items-center gap-3 cursor-pointer group hover:translate-x-1 transition-transform mb-3">
                <input type="radio" name="${containerId}-radio" value="all" checked class="studio-checkbox" />
                <span class="font-bold text-sm uppercase">${messages.filters.allCategories}</span>
            </label>
        `;
        categories.forEach(cat => {
            const label = document.createElement('label');
            label.className = "flex items-center gap-3 cursor-pointer group hover:translate-x-1 transition-transform mb-3";
            label.innerHTML = `
                <input type="radio" name="${containerId}-radio" value="${cat}" class="studio-checkbox" />
                <span class="font-bold text-sm uppercase">${cat}</span>
            `;
            container.appendChild(label);
        });
    };

    const renderTags = (containerId) => {
        const container = document.getElementById(containerId);
        if(!container) return;
        popularTags.forEach(tag => {
            const btn = document.createElement('button');
            btn.dataset.tag = tag;
            btn.className = "tag-filter border border-ink bg-white px-2 py-1 text-xs font-bold uppercase hover:bg-ink hover:text-white transition-colors";
            btn.textContent = tag;
            container.appendChild(btn);
        });
    };

    renderCats('category-filters');
    renderTags('tag-filters');
}

// --- 4. INTERACTION ---
function initLogic() {
    const searchInput = document.getElementById('search-input');
    let state = { search: '', category: 'all', tag: null };

    const runFilter = () => {
        const cards = document.querySelectorAll('.job-card');
        let count = 0;
        cards.forEach(card => {
            const matchS = state.search === '' || card.dataset.title.includes(state.search) || card.dataset.company.includes(state.search) || card.dataset.tags.includes(state.search);
            const matchC = state.category === 'all' || card.dataset.category === state.category;
            const matchT = state.tag === null || card.dataset.tags.includes(state.tag.toLowerCase());

            if (matchS && matchC && matchT) {
                card.style.display = 'flex';
                count++;
            } else {
                card.style.display = 'none';
            }
        });
        
        const empty = document.getElementById('empty-state');
        if (count === 0) empty.classList.remove('hidden'); 
        else empty.classList.add('hidden');
        document.getElementById('job-count').textContent = count;
    };

    // Search
    searchInput.addEventListener('input', (e) => { state.search = e.target.value.toLowerCase(); runFilter(); });

    // Categories
    document.addEventListener('change', (e) => {
        if (e.target.name && e.target.name.includes('radio')) {
            state.category = e.target.value;
            runFilter();
        }
    });

    // Tags (Delegate)
    document.addEventListener('click', (e) => {
        if (e.target.classList.contains('tag-filter')) {
            const tag = e.target.dataset.tag;
            const isActive = state.tag === tag;
            state.tag = isActive ? null : tag;

            // Update UI
            document.querySelectorAll('.tag-filter').forEach(b => {
                if (b.dataset.tag === state.tag) {
                    b.classList.remove('bg-white', 'text-black');
                    b.classList.add('bg-ink', 'text-white');
                } else {
                    b.classList.add('bg-white', 'text-black');
                    b.classList.remove('bg-ink', 'text-white');
                }
            });
            runFilter();
        }
    });

    // Clear
    document.getElementById('clear-filters').addEventListener('click', () => {
        state = { search: '', category: 'all', tag: null };
        searchInput.value = '';
        document.querySelector('input[value="all"]').checked = true;
        document.querySelectorAll('.tag-filter').forEach(b => {
            b.classList.add('bg-white', 'text-black');
            b.classList.remove('bg-ink', 'text-white');
        });
        runFilter();
    });
}

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('job-count').textContent = jobsData.length;
    renderFilters();
    initLogic();
});
</script>
