---
import jobs from '../data/jobs.json';
import JobCard from '../components/JobCard.astro';
import SearchBar from '../components/SearchBar.astro';
import CategoryButtons from '../components/CategoryButtons.astro';
import Layout from '../layouts/Layout.astro';
import Badge from '../components/ui/Badge.astro';
import '../styles/global.css';
import { sortJobsByDateDesc, collectFacets, slugify } from '../lib/jobs';

import type { Job } from '../lib/jobs';

// Use shared helpers so behavior is covered by unit tests
const sortedJobs = sortJobsByDateDesc(jobs as Job[]);
const { categories, tags } = collectFacets(jobs as Job[]);

// SEO helpers
const site = Astro.site ?? new URL('http://localhost:4321');
const seo = {
  title: 'ArtSource Brazil — Remote Creative Jobs',
  description:
    'Niche job board for Brazil-based creative talent: Game Dev, 3D & Animation, and UI/UX Design. Find curated remote roles from international studios.',
  image: '/images/artsource-brazil-logo.svg',
};

// JSON-LD: one JobPosting per job
const jobPostings = sortedJobs.map((j) => ({
  '@context': 'https://schema.org',
  '@type': 'JobPosting',
  title: j.jobTitle,
  datePosted: j.postedDate,
  employmentType: 'CONTRACT',
  jobLocationType: 'TELECOMMUTE',
  hiringOrganization: {
    '@type': 'Organization',
    name: j.companyName,
    logo: new URL(j.companyLogo, site).href,
  },
  description: `${j.category} — ${j.tags.join(', ')}`,
  directApply: true,
  applicationContact: undefined,
  applicantLocationRequirements: {
    '@type': 'Country',
    name: 'Brazil',
  },
  identifier: {
    '@type': 'PropertyValue',
    name: j.companyName,
    value: j.id,
  },
  url: j.applyLink,
}));
---

<Layout seo={seo}>
  <Fragment slot="head">
    <!-- JSON-LD: JobPostings -->
    <script type="application/ld+json" set:html={JSON.stringify(jobPostings)} />
  </Fragment>

  <main class="container mx-auto px-container py-section-sm">
    <!-- Hero section -->
    <div class="mb-12 text-center animate-fade-in-up">
      <h1 class="mb-4 font-serif text-5xl font-bold tracking-tight text-neutral-900 sm:text-6xl">
        Find Your Next Creative Role
      </h1>
      <p class="mx-auto max-w-2xl text-lg text-neutral-700">
        Remote opportunities for Brazilian artists, designers, and game developers
      </p>
    </div>

    <!-- Search Bar (Primary filtering method) -->
    <div class="relative z-30 animate-fade-in" style="animation-delay: 0.1s; animation-fill-mode: both;">
      <SearchBar />
    </div>

    <!-- Category Buttons (Active filters) -->
    <div class="relative z-10 animate-fade-in" style="animation-delay: 0.15s; animation-fill-mode: both;">
      <CategoryButtons categories={categories} />
    </div>

    <!-- SEO-friendly links to category pages (hidden, for crawlers) -->
    <nav class="sr-only" aria-label="Browse by category">
      {
        categories.map((cat) => {
          const slug = slugify(cat);
          return (
            <a href={`/category/${slug}`}>
              {cat} jobs
            </a>
          );
        })
      }
    </nav>

    <!-- Job Cards Results -->
    <div class="space-y-6 animate-fade-in" style="animation-delay: 0.2s; animation-fill-mode: both;" data-jobs>
      {
        sortedJobs.map((job: Job) => (
          <JobCard
            job={job}
            data-testid="job-card"
            data-category={job.category}
            data-tags={job.tags.join(' ')}
            data-text={`${job.jobTitle} ${job.companyName}`}
          />
        ))
      }
    </div>
  </main>
</Layout>

<script>
  // @ts-nocheck
  // Global filter orchestrator: single source of truth for filters
  (function () {
    const params = new URLSearchParams(location.search);
  /**
   * @param {string} key
   * @returns {string[]}
   */
  const parseCsv = (key) => (params.get(key) || '').split(',').filter(Boolean);

    const state = {
      search: params.get('q') || '',
      category: params.get('category') || 'all',
      level: parseCsv('level'),
      tools: parseCsv('tools'),
      contract: parseCsv('contract'),
      location: parseCsv('location'),
    };

    /** @returns {HTMLElement[]} */
    function getItems() {
      const container = document.querySelector('[data-jobs]');
      return Array.from(container ? container.children : []);
    }

    /**
     * @param {string} tagString
     * @param {string[]} arr
     */
    /**
     * @param {string} tagString
     * @param {string[]} arr
     * @returns {boolean}
     */
    function includesAll(tagString, arr) {
      if (!arr || arr.length === 0) return true;
      const set = new Set((tagString || '').toLowerCase().split(/\s+/).filter(Boolean));
      return arr.every((v) => set.has(String(v).toLowerCase()));
    }

    function apply() {
      const items = getItems();
      const qLower = (state.search || '').toLowerCase();

      items.forEach((el) => {
        const tagsStr = (el.getAttribute('data-tags') || '').toLowerCase();
        const text = (el.getAttribute('data-text') || '').toLowerCase();
        const jobCategory = el.getAttribute('data-category') || '';

        let show = true;
        if (state.category && state.category !== 'all') {
          show = jobCategory === state.category;
        }
        if (show && qLower) {
          show = text.includes(qLower) || tagsStr.includes(qLower);
        }

        // Advanced filters: match by tags for now (Level/Tools often appear as tags)
        if (show && !includesAll(tagsStr, state.level)) show = false;
        if (show && !includesAll(tagsStr, state.tools)) show = false;
        // Contract/Location could be supported later when data is available

        el.classList.toggle('hidden', !show);
      });

      // Sync URL with current state
      const next = new URLSearchParams();
      if (state.search) next.set('q', state.search);
      if (state.category && state.category !== 'all') next.set('category', state.category);
      if (state.level?.length) next.set('level', state.level.join(','));
      if (state.tools?.length) next.set('tools', state.tools.join(','));
      if (state.contract?.length) next.set('contract', state.contract.join(','));
      if (state.location?.length) next.set('location', state.location.join(','));
      const url = `${location.pathname}${next.toString() ? `?${next.toString()}` : ''}`;
      history.replaceState({}, '', url);

      // Notify listeners
      window.dispatchEvent(new CustomEvent('jobfilters:applied', { detail: { ...state } }));
    }

    // Listen for filter changes from components
    window.addEventListener('jobfilters:change', (ev) => {
      /** @type {CustomEvent} */
      const ce = ev as CustomEvent;
      const detail = (ce.detail || {});
      Object.assign(state, detail as Record<string, any>);
      apply();
    });

    // Initial apply after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', apply);
    } else {
      apply();
    }
  })();
</script>
