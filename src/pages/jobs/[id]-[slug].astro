---
import { Image } from 'astro:assets';
import { getCachedJobs } from '../../lib/getJobs';
import Layout from '../../layouts/Layout.astro';
import JobCard from '../../components/JobCard.astro';
import ShareButtons from '../../components/ShareButtons.astro';
import Button from '../../components/ui/Button.astro';
import Badge from '../../components/ui/Badge.astro';
import Card from '../../components/ui/Card.astro';
import Link from '../../components/ui/Link.astro';
import Breadcrumb from '../../components/ui/Breadcrumb.astro';
import { slugify } from '../../lib/jobs';
import type { Job } from '../../lib/jobs';
import { renderMarkdownToHtml, markdownToPlainText } from '../../lib/helpers/markdown';
import {
  getApplicantLocationRequirement,
  getJobLocationCountryCode,
  getJobLocationType,
  getLocationLabel,
} from '../../lib/location';

export async function getStaticPaths() {
  const allJobs = await getCachedJobs();
  return allJobs.map((job) => ({
    params: {
      id: job.id,
      slug: slugify(job.jobTitle),
    },
    props: { job },
  }));
}

interface Props {
  job: Job;
}

const { job } = Astro.props;
const site = Astro.site ?? new URL('http://localhost:4321');
const canonicalUrl = new URL(Astro.url.pathname, site).href;
const locationLabel = getLocationLabel(job.location.scope);
const locationNote = (job.location.note || '').trim();
const locationCountryCode = getJobLocationCountryCode(job.location);
const structuredLocality = locationLabel.replace(/\s*•\s*/g, ' - ');

// Get all jobs for related jobs
const allJobs = await getCachedJobs();

// Related jobs: same category, excluding current
const relatedJobs = allJobs
  .filter((j) => j.category === job.category && j.id !== job.id)
  .slice(0, 3);

// Format date for display
const postedDate = new Date(job.postedDate);
const formattedDate = postedDate.toLocaleDateString('pt-BR', {
  year: 'numeric',
  month: 'long',
  day: 'numeric',
});

// SEO
const plainDescription = markdownToPlainText(job.description);
const metaDescription =
  plainDescription.length > 160 ? `${plainDescription.slice(0, 157)}…` : plainDescription;

const seo = {
  title: `${job.jobTitle} na ${job.companyName} | Art Source Brazil`,
  description: metaDescription || `Candidatar-se para ${job.jobTitle} na ${job.companyName}.`,
  image: `/og/${job.id}-${slugify(job.jobTitle)}.png`,
};

// JobPosting JSON-LD (more complete than homepage)
const jobPosting = {
  '@context': 'https://schema.org',
  '@type': 'JobPosting',
  title: job.jobTitle,
  description: plainDescription,
  datePosted: job.postedDate,
  validThrough: new Date(
    new Date(job.postedDate).getTime() + 30 * 24 * 60 * 60 * 1000,
  ).toISOString(), // 30 days validity
  employmentType: 'CONTRACTOR',
  jobLocationType: getJobLocationType(job.location.scope),
  applicantLocationRequirements: getApplicantLocationRequirement(job.location),
  hiringOrganization: {
    '@type': 'Organization',
    name: job.companyName,
    sameAs: job.companyWebsite || job.applyLink, // Prefer company website
    logo: new URL(job.companyLogo, site).href,
  },
  jobLocation: {
    '@type': 'Place',
    address: {
      '@type': 'PostalAddress',
      addressCountry: locationCountryCode ?? undefined,
      addressLocality: structuredLocality,
    },
  },
  identifier: {
    '@type': 'PropertyValue',
    name: job.companyName,
    value: job.id,
  },
  ...(job.salary && {
    baseSalary: {
      '@type': 'MonetaryAmount',
      currency: job.salary.currency || 'BRL',
      value: {
        '@type': 'QuantitativeValue',
        ...(job.salary.min && { minValue: job.salary.min }),
        ...(job.salary.max && { maxValue: job.salary.max }),
        unitText: job.salary.unit || 'MONTH',
      },
    },
  }),
};

// BreadcrumbList JSON-LD
const breadcrumbs = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    {
      '@type': 'ListItem',
      position: 1,
      name: 'Home',
      item: new URL('/', site).href,
    },
    {
      '@type': 'ListItem',
      position: 2,
      name: job.category,
      item: new URL(`/category/${slugify(job.category)}`, site).href,
    },
    {
      '@type': 'ListItem',
      position: 3,
      name: job.jobTitle,
      item: canonicalUrl,
    },
  ],
};
---

<Layout seo={seo}>
  <Fragment slot="head">
    <!-- JobPosting JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(jobPosting)} />
    <!-- Breadcrumbs JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(breadcrumbs)} />
  </Fragment>

  <main class="container mx-auto px-6 py-12">
    <!-- Breadcrumbs -->
    <Breadcrumb
      class="mb-6"
      items={[
        { label: 'Home', href: '/' },
        { label: job.category, href: `/category/${slugify(job.category)}` },
        { label: job.jobTitle },
      ]}
    />

    <!-- Two-column layout: Main Content + Sidebar -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Main Content (2/3 width on desktop) -->
      <article class="lg:col-span-2">
        <!-- Header -->
        <Card padding="lg" class="mb-8">
          <div class="flex items-start gap-6">
            <!-- Company Logo -->
            <div class="flex-shrink-0">
              <Image
                src={job.companyLogo}
                alt={`${job.companyName} logo`}
                width={80}
                height={80}
                loading="lazy"
                class="h-20 w-20 rounded-lg border border-neutral-200 object-cover"
              />
            </div>

            <!-- Job Info -->
            <div class="flex-grow">
              <h1 class="mb-2 text-4xl font-bold text-neutral-900">{job.jobTitle}</h1>
              <p class="mb-3 text-xl text-neutral-700">
                <Link href={`/company/${slugify(job.companyName)}`} variant="secondary" underline={true}>
                  {job.companyName}
                </Link>
              </p>

              <!-- Meta Info -->
              <div class="flex flex-wrap gap-4 text-sm text-neutral-600">
                <span class="flex items-center gap-1">
                  <svg class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M128,64a40,40,0,1,0,40,40A40,40,0,0,0,128,64Zm0,64a24,24,0,1,1,24-24A24,24,0,0,1,128,128Zm0-112a88.1,88.1,0,0,0-88,88c0,31.4,14.51,64.68,42,96.25a254.19,254.19,0,0,0,41.45,38.3,8,8,0,0,0,9.18,0A254.19,254.19,0,0,0,174,200.25c27.45-31.57,42-64.85,42-96.25A88.1,88.1,0,0,0,128,16Zm0,206c-16.53-13-72-60.75-72-118a72,72,0,0,1,144,0C200,161.23,144.53,209,128,222Z"/>
                  </svg>
                  {locationLabel}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM72,48v8a8,8,0,0,0,16,0V48h80v8a8,8,0,0,0,16,0V48h24V80H48V48ZM208,208H48V96H208V208Zm-96-88v64a8,8,0,0,1-16,0V132.94l-4.42,2.22a8,8,0,0,1-7.16-14.32l16-8A8,8,0,0,1,112,120Zm59.16,30.45L152,176h16a8,8,0,0,1,0,16H136a8,8,0,0,1-6.4-12.8l28.78-38.37A8,8,0,1,0,145.07,132a8,8,0,1,1-13.85-8A24,24,0,0,1,176,136,23.76,23.76,0,0,1,171.16,150.45Z"/>
                  </svg>
                  Publicada em {formattedDate}
                </span>
                <span class="flex items-center gap-1">
                  <svg class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M216,40H40A16,16,0,0,0,24,56V200a16,16,0,0,0,16,16H216a16,16,0,0,0,16-16V56A16,16,0,0,0,216,40ZM40,56H216V88H40ZM40,200V104H216v96Z"/>
                  </svg>
                  {job.category}
                </span>
              </div>
              {locationNote && (
                <p class="mt-2 text-sm font-medium text-neutral-600 flex items-center gap-1">
                  <svg class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256">
                    <path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24Zm0,192a88,88,0,1,1,88-88A88.1,88.1,0,0,1,128,216Zm64-88a8,8,0,0,1-8,8H128a8,8,0,0,1-8-8V72a8,8,0,0,1,16,0v48h48A8,8,0,0,1,192,128Z"/>
                  </svg>
                  {locationNote}
                </p>
              )}

              <!-- Tags -->
              <div class="mt-4 flex flex-wrap gap-2">
                {job.tags.map((tag) => <Badge variant="accent">{tag}</Badge>)}
              </div>
            </div>
          </div>
        </Card>

        <!-- Job Description Section -->
        <Card padding="lg" class="mb-8">
          <h2 class="mb-4 text-2xl font-bold text-neutral-900">Sobre a vaga</h2>
          <div
            class="prose prose-lg max-w-none text-neutral-700"
            set:html={renderMarkdownToHtml(job.description)}
          />

          <!-- Apply Button -->
          <div class="mt-6">
            <Button
              href={job.applyLink}
              target="_blank"
              rel="noopener noreferrer"
              size="lg"
              class="w-full"
            >
              Candidatar-se a esta vaga →
            </Button>
          </div>

          <!-- Share Buttons -->
          <div class="mt-6 pt-6 border-t border-neutral-200">
            <p class="text-sm text-neutral-600 mb-3">Compartilhe esta vaga:</p>
            <ShareButtons url={canonicalUrl} title={job.jobTitle} className="justify-start" />
          </div>
        </Card>
      </article>

      <!-- Sidebar (1/3 width on desktop) -->
      <aside class="lg:col-span-1">
        <div class="space-y-6 lg:sticky lg:top-6 lg:self-start">
        <!-- Company Info Box -->
        <Card padding="lg" class="bg-neutral-50">
          <h2 class="mb-4 text-xl font-bold text-neutral-900">Sobre {job.companyName}</h2>
          <div class="space-y-4">
            <Image
              src={job.companyLogo}
              alt={`${job.companyName} logo`}
              width={64}
              height={64}
              loading="lazy"
              class="h-16 w-16 rounded-lg border border-neutral-300 object-cover mx-auto"
            />
            <p class="text-sm text-neutral-700">
              {job.companyName} está contratando para posições de {job.category}. Confira outras oportunidades
              e entenda mais sobre a cultura da empresa.
            </p>
            <Link
              href={job.applyLink}
              target="_blank"
              rel="noopener noreferrer"
              class="block text-center"
            >
              Visitar site da empresa →
            </Link>
          </div>
        </Card>

        <!-- Newsletter Box -->
        <Card padding="lg" class="bg-accent-light">
          <h3 class="mb-2 text-lg font-bold text-neutral-900">Fique por dentro</h3>
          <p class="mb-4 text-sm text-neutral-700">Receba as vagas mais recentes diretamente no seu e-mail.</p>
          <form
            action="https://buttondown.email/api/emails/embed-subscribe/artsourcebrazil"
            method="post"
            target="popupwindow"
            class="space-y-2"
          >
            <input
              type="email"
              name="email"
              placeholder="seu-email@exemplo.com"
              required
              class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
            />
            <Button type="submit" size="sm" class="w-full">
              Assinar
            </Button>
          </form>
          <p class="mt-2 text-xs text-neutral-600">
            Respeitamos sua privacidade. Sem spam. Powered by <a href="https://buttondown.email" target="_blank" rel="noopener noreferrer" class="underline hover:text-primary">Buttondown</a>.
          </p>
        </Card>
        </div>
      </aside>
    </div>

    <!-- Related Jobs Section -->
    {
      relatedJobs.length > 0 && (
        <section class="mt-16 pt-12 border-t-2 border-neutral-200">
          <div class="mb-8 text-center">
            <h2 class="text-3xl font-bold text-neutral-900 mb-2">Vagas similares em {job.category}</h2>
            <p class="text-neutral-600">Outras oportunidades que podem te interessar</p>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {relatedJobs.map((relatedJob) => (
              <Card class="relative overflow-hidden bg-white flex flex-col h-full">
                <div class="flex flex-col gap-4 flex-grow">
                  <!-- Company Logo + Badge -->
                  <div class="flex items-start justify-between gap-3">
                    <div class="flex-shrink-0">
                      <div class="rounded-xl bg-white p-2 border-2 border-neutral-900 shadow-sm">
                        <Image
                          src={relatedJob.companyLogo}
                          alt={`${relatedJob.companyName} logo`}
                          width={48}
                          height={48}
                          loading="lazy"
                          class="h-12 w-12 object-contain"
                        />
                      </div>
                    </div>
                    <div class="flex flex-col gap-1 flex-1 min-w-0">
                      <Badge variant="primary" size="sm" class="w-fit">
                        {relatedJob.companyName}
                      </Badge>
                      <Link
                        href={`/category/${slugify(relatedJob.category)}`}
                        variant="secondary"
                        class="text-xs font-semibold text-neutral-600 hover:text-primary truncate"
                      >
                        {relatedJob.category}
                      </Link>
                    </div>
                    {(()=> {
                      const posted = new Date(relatedJob.postedDate);
                      const now = Date.now();
                      const diffTime = now - posted.getTime();
                      const diffDays = diffTime / (1000 * 60 * 60 * 24);
                      const isNew = 7 >= diffDays;
                      if (isNew) {
                        return <Badge variant="accent" size="sm" class="font-extrabold shrink-0">Nova</Badge>;
                      }
                      return null;
                    })()}
                  </div>

                  <!-- Job Title -->
                  <h2 class="font-serif text-xl font-bold leading-tight text-neutral-950 line-clamp-2">
                    <Link 
                      href={`/jobs/${relatedJob.id}-${slugify(relatedJob.jobTitle)}`} 
                      variant="secondary" 
                      class="hover:text-primary"
                    >
                      {relatedJob.jobTitle}
                    </Link>
                  </h2>

                  <!-- Metadata -->
                  <div class="flex flex-wrap items-center gap-2 text-xs">
                    <span class="inline-flex items-center gap-1 rounded-full bg-neutral-100 border border-neutral-300 px-2 py-0.5 font-semibold text-neutral-700">
                      <svg class="h-3 w-3 text-primary" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M128,64a40,40,0,1,0,40,40A40,40,0,0,0,128,64Zm0,64a24,24,0,1,1,24-24A24,24,0,0,1,128,128Zm0-112a88.1,88.1,0,0,0-88,88c0,31.4,14.51,64.68,42,96.25a254.19,254.19,0,0,0,41.45,38.3,8,8,0,0,0,9.18,0A254.19,254.19,0,0,0,174,200.25c27.45-31.57,42-64.85,42-96.25A88.1,88.1,0,0,0,128,16Zm0,206c-16.53-13-72-60.75-72-118a72,72,0,0,1,144,0C200,161.23,144.53,209,128,222Z"/>
                      </svg>
                      {getLocationLabel(relatedJob.location.scope)}
                    </span>
                    <span class="flex items-center gap-1 font-semibold text-neutral-600">
                      <svg class="h-3 w-3 text-primary" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM72,48v8a8,8,0,0,0,16,0V48h80v8a8,8,0,0,0,16,0V48h24V80H48V48ZM208,208H48V96H208V208Zm-96-88v64a8,8,0,0,1-16,0V132.94l-4.42,2.22a8,8,0,0,1-7.16-14.32l16-8A8,8,0,0,1,112,120Zm59.16,30.45L152,176h16a8,8,0,0,1,0,16H136a8,8,0,0,1-6.4-12.8l28.78-38.37A8,8,0,1,0,145.07,132a8,8,0,1,1-13.85-8A24,24,0,0,1,176,136,23.76,23.76,0,0,1,171.16,150.45Z"/>
                      </svg>
                      {new Date(relatedJob.postedDate).toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' })}
                    </span>
                  </div>

                  <!-- Tags (max 5) -->
                  <div class="flex flex-wrap gap-1.5">
                    {relatedJob.tags.slice(0, 5).map((tag) => (
                      <Badge variant="default" size="sm" class="text-xs">
                        {tag}
                      </Badge>
                    ))}
                    {relatedJob.tags.length > 5 && (
                      <Badge variant="default" size="sm" class="bg-neutral-200 border border-neutral-400 text-neutral-700 text-xs">
                        +{relatedJob.tags.length - 5}
                      </Badge>
                    )}
                  </div>
                </div>

                <!-- CTA Button -->
                <div class="mt-4 pt-4 border-t border-neutral-200">
                  <Button
                    href={`/jobs/${relatedJob.id}-${slugify(relatedJob.jobTitle)}`}
                    size="sm"
                    class="w-full"
                  >
                    Ver detalhes
                  </Button>
                </div>
              </Card>
            ))}
          </div>
          <div class="mt-10 text-center">
            <Button href={`/category/${slugify(job.category)}`} variant="outline" size="lg">
              Explorar todas as vagas de {job.category} →
            </Button>
          </div>
        </section>
      )
    }
  </main>
</Layout>
