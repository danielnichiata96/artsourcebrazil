---
// FiltersSidebar component - Consolidated filtering sidebar
import Button from './ui/Button.astro';
import CategoryFilter from './CategoryFilter.astro';
import MultiSelectDropdown from './ui/MultiSelectDropdown.astro';
import type { Locale, Messages } from '../lib/i18n';
import { getMessages } from '../lib/i18n';

export interface Props {
  categories: string[];
  locale: Locale;
}

const { categories = [], locale } = Astro.props as Props;
const messages = getMessages(locale);
const filtersMessages = messages.filters;
const resultsMessages = messages.results;

// Filter options
const toolOptions = ['Unity', 'Unreal Engine', 'Figma', 'C#', 'Blender', 'Maya', '3ds Max', 'Houdini', 'Substance Painter/Designer', 'Python', 'Javascript'];
const levelOptions = ['Senior', 'Lead'];
const locationOptions = [
  { value: 'remote-brazil', label: 'Remoto • Brasil' },
  { value: 'remote-worldwide', label: 'Remoto • Global' },
];
---

<!-- Filtros Sidebar - Estilo Card Editorial -->
<aside
  id="filters-sidebar"
  class="rounded-2xl border-thick border-neutral-900 bg-white shadow-illustration overflow-hidden flex flex-col max-h-[calc(100vh-8rem)]"
  aria-label={filtersMessages.toggle}
>
  <!-- Conteúdo Scrollável dos Filtros -->
  <div class="space-y-4 pt-4 px-5 pb-5 overflow-y-auto flex-1">
    <!-- Search Bar - Estilo Editorial -->
    <div>
      <label for="job-search-sidebar" class="mb-2 block font-serif text-base font-bold text-neutral-950">
        {filtersMessages.searchLabel}
      </label>
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-primary"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <input
          id="job-search-sidebar"
          type="search"
          inputmode="search"
          placeholder={filtersMessages.searchPlaceholder}
          aria-label={filtersMessages.searchLabel}
          class="w-full border-thick border-neutral-900 bg-white py-3 pl-10 pr-4 text-sm font-bold text-neutral-950 shadow-illustration transition-all placeholder:text-neutral-400 hover:border-primary focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
        />
      </div>
    </div>

    <!-- Resumo de filtros -->
    <div class="rounded-xl border-thick border-neutral-900 bg-white p-3 shadow-illustration">
      <div class="flex items-center justify-between gap-2">
        <div class="min-w-0 flex-1">
          <p class="text-xs font-semibold uppercase tracking-widest text-neutral-500">
            {filtersMessages.sidebarTitle}
          </p>
          <div class="mt-1 flex items-baseline gap-2">
            <span class="font-serif text-2xl font-bold text-primary" data-sidebar-results-count>0</span>
            <span class="text-sm text-neutral-600" data-sidebar-count-label>{resultsMessages.countPlural}</span>
          </div>
        </div>
        <button
          type="button"
          data-sidebar-clear
          class="inline-flex shrink-0 items-center gap-1 rounded-full border-2 border-neutral-900 bg-white px-2 py-1 text-xs font-bold uppercase tracking-wide text-neutral-900 transition hover:bg-primary-light hover:border-primary hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-40"
          disabled
        >
          <span class="hidden sm:inline">{filtersMessages.sidebarClear}</span>
          <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
      <div
        class="mt-3 flex flex-wrap gap-2"
        data-sidebar-active-filters
        data-empty-message={filtersMessages.sidebarEmpty}
        aria-live="polite"
      >
        <span class="text-xs text-neutral-500">{filtersMessages.sidebarEmpty}</span>
      </div>
    </div>

      <!-- Category Filter -->
  <div class="mb-6">
    <h2 class="mb-2 font-serif text-base font-bold text-neutral-950">{filtersMessages.category}</h2>
    <CategoryFilter
      categories={categories}
    />

    <!-- Dropdown Filters -->
    <div class="space-y-4 pb-8">
      <MultiSelectDropdown
        label={filtersMessages.tools}
        name="tools"
        options={toolOptions}
        id="tools-dropdown"
      >
        <svg slot="icon" class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256" aria-hidden="true">
          <path d="M226.76,69a8,8,0,0,0-12.84-2.88l-40.3,37.19-17.23-3.7-3.7-17.23,37.19-40.3A8,8,0,0,0,187,29.24,72,72,0,0,0,88,96,72.34,72.34,0,0,0,94,124.94L33.79,177c-.15.12-.29.26-.43.39a32,32,0,0,0,45.26,45.26c.13-.13.27-.28.39-.42L131.06,162A72,72,0,0,0,232,96,71.56,71.56,0,0,0,226.76,69ZM160,152a56.14,56.14,0,0,1-27.07-7,8,8,0,0,0-9.92,1.77L67.11,211.51a16,16,0,0,1-22.62-22.62L109.18,133a8,8,0,0,0,1.77-9.93,56,56,0,0,1,58.36-82.31l-31.2,33.81a8,8,0,0,0-1.94,7.1L141.83,108a8,8,0,0,0,6.14,6.14l26.35,5.66a8,8,0,0,0,7.1-1.94l33.81-31.2A56.06,56.06,0,0,1,160,152Z"/>
        </svg>
      </MultiSelectDropdown>

      <MultiSelectDropdown
        label={filtersMessages.level}
        name="level"
        options={levelOptions}
        id="level-dropdown"
      >
        <svg slot="icon" class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256" aria-hidden="true">
          <path d="M224,200h-8V40a8,8,0,0,0-8-8H152a8,8,0,0,0-8,8V80H96a8,8,0,0,0-8,8v40H48a8,8,0,0,0-8,8v64H32a8,8,0,0,0,0,16H224a8,8,0,0,0,0-16ZM160,48h40V200H160ZM104,96h40V200H104ZM56,144H88v56H56Z"/>
        </svg>
      </MultiSelectDropdown>

      <!-- Location Dropdown (inline for custom labels) -->
      <div class="relative" data-dropdown="dropdown-location">
        <button
          type="button"
          data-dropdown-trigger
          class="w-full flex items-center justify-between border-thick border-neutral-900 bg-white px-4 py-3 text-left text-sm font-bold text-neutral-950 shadow-illustration transition-all hover:border-primary hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          aria-expanded="false"
        >
          <span class="flex items-center gap-2 flex-1">
            <svg class="h-4 w-4 text-primary" fill="currentColor" viewBox="0 0 256 256" aria-hidden="true">
              <path d="M128,64a40,40,0,1,0,40,40A40,40,0,0,0,128,64Zm0,64a24,24,0,1,1,24-24A24,24,0,0,1,128,128Zm0-112a88.1,88.1,0,0,0-88,88c0,31.4,14.51,64.68,42,96.25a254.19,254.19,0,0,0,41.45,38.3,8,8,0,0,0,9.18,0A254.19,254.19,0,0,0,174,200.25c27.45-31.57,42-64.85,42-96.25A88.1,88.1,0,0,0,128,16Zm0,206c-16.53-13-72-60.75-72-118a72,72,0,0,1,144,0C200,161.23,144.53,209,128,222Z"/>
            </svg>
            {filtersMessages.location}
          </span>
          <div class="flex items-center gap-2">
            <span data-count class="text-xs font-semibold text-primary"></span>
            <svg
              data-chevron
              class="h-4 w-4 transition-transform text-neutral-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </button>
        <div
          data-dropdown-content
          class="absolute left-0 right-0 top-full z-50 mt-1 hidden max-h-64 overflow-y-auto border-thick border-neutral-900 bg-white shadow-xl"
        >
          <div class="p-2 space-y-1">
            {locationOptions.map((option) => (
              <label class="flex items-center gap-2 cursor-pointer p-2 transition-colors hover:bg-primary-lightest">
                <input
                  type="checkbox"
                  name="location"
                  value={option.value}
                  class="h-4 w-4 shrink-0 border-neutral-300 text-primary focus:ring-primary"
                  data-dropdown-checkbox
                />
                <span class="text-sm font-semibold text-neutral-950">{option.label}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

  <!-- Action Buttons - Footer Fixo (fora do scroll) -->
  <div class="shrink-0 border-t-4 border-neutral-900 bg-white p-6 space-y-2">
    <Button
      id="apply-filters-sidebar"
      type="button"
      variant="primary"
      size="md"
      class="w-full disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {filtersMessages.apply}
    </Button>
    <Button
      id="clear-filters-sidebar"
      type="button"
      variant="outline"
      size="md"
      class="w-full"
    >
      {filtersMessages.clear}
    </Button>
  </div>
</aside>

<script>
  import { FiltersSidebarController } from '../lib/filters/sidebar-controller';

  // Wait for DOM to be ready (including MultiSelectDropdown initialization)
  document.addEventListener('DOMContentLoaded', () => {
    // Gather all required DOM elements
    const sidebar = document.getElementById('filters-sidebar') as HTMLElement;
    const searchInput = document.getElementById('job-search-sidebar') as HTMLInputElement;
    const categoryButtons = Array.from(
      document.querySelectorAll<HTMLButtonElement>('.category-btn-sidebar')
    );
    const applyBtn = document.getElementById('apply-filters-sidebar') as HTMLButtonElement;
    const clearBtn = document.getElementById('clear-filters-sidebar') as HTMLButtonElement;
    const summaryClearBtn = document.querySelector('[data-sidebar-clear]') as HTMLButtonElement | null;

    // Checkbox groups
    const levelCheckboxes = Array.from(
      document.querySelectorAll<HTMLInputElement>('input[name="level"]')
    );
    const toolsCheckboxes = Array.from(
      document.querySelectorAll<HTMLInputElement>('input[name="tools"]')
    );
    const locationCheckboxes = Array.from(
      document.querySelectorAll<HTMLInputElement>('input[name="location"]')
    );

    // Initialize controller with all elements
    new FiltersSidebarController({
      sidebar,
      overlay: null,
      toggleBtn: null,
      closeBtn: null,
      searchInput,
      categoryButtons,
      applyBtn,
      clearBtn,
      checkboxGroups: {
        level: levelCheckboxes,
        tools: toolsCheckboxes,
        location: locationCheckboxes,
      },
    });

    summaryClearBtn?.addEventListener('click', () => clearBtn?.click());
  });
</script>
