---
// FiltersSidebar component - Consolidated filtering sidebar
import Button from './ui/Button.astro';
import MultiSelectDropdown from './ui/MultiSelectDropdown.astro';
import type { Locale, Messages } from '../lib/i18n';
import { getMessages } from '../lib/i18n';

export interface Props {
  categories: string[];
  locale: Locale;
}

const { categories = [], locale } = Astro.props as Props;
const messages = getMessages(locale);
const filtersMessages = messages.filters;
const resultsMessages = messages.results;

// Filter options
const toolOptions = ['Unity', 'Unreal Engine', 'Figma', 'C#', 'Blender', 'Maya', '3ds Max', 'Houdini', 'Substance Painter/Designer', 'Python', 'Javascript'];
const levelOptions = ['Senior', 'Lead'];
const locationOptions = [
  { value: 'remote-brazil', label: 'Remoto • Brasil' },
  { value: 'remote-worldwide', label: 'Remoto • Global' },
];
---

<!-- Filtros Sidebar - Estilo Card Editorial -->
<aside
  id="filters-sidebar"
  class="rounded-2xl border-thick border-neutral-900 bg-white shadow-illustration overflow-hidden flex flex-col max-h-[calc(100vh-8rem)]"
  aria-label={filtersMessages.toggle}
>
  <!-- Conteúdo Scrollável dos Filtros -->
  <div class="space-y-4 pt-4 px-5 pb-5 overflow-y-auto flex-1">
    <!-- Search Bar - Estilo Editorial -->
    <div>
      <label for="job-search-sidebar" class="mb-2 block font-serif text-base font-bold text-neutral-950">
        {filtersMessages.searchLabel}
      </label>
      <div class="relative">
        <svg
          class="absolute left-3 top-1/2 h-5 w-5 -translate-y-1/2 text-primary"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
          aria-hidden="true"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
          />
        </svg>
        <input
          id="job-search-sidebar"
          type="search"
          inputmode="search"
          placeholder={filtersMessages.searchPlaceholder}
          aria-label={filtersMessages.searchLabel}
          class="w-full border-thick border-neutral-900 bg-white py-3 pl-10 pr-4 text-sm font-bold text-neutral-950 shadow-illustration transition-all placeholder:text-neutral-400 hover:border-primary focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20"
        />
      </div>
    </div>

    <!-- Resumo de filtros -->
    <div class="rounded-xl border-thick border-neutral-900 bg-white p-3 shadow-illustration">
      <div class="flex items-center justify-between gap-2">
        <div class="min-w-0 flex-1">
          <p class="text-xs font-semibold uppercase tracking-widest text-neutral-500">
            {filtersMessages.sidebarTitle}
          </p>
          <div class="mt-1 flex items-baseline gap-2">
            <span class="font-serif text-2xl font-bold text-primary" data-sidebar-results-count>0</span>
            <span class="text-sm text-neutral-600" data-sidebar-count-label>{resultsMessages.countPlural}</span>
          </div>
        </div>
        <button
          type="button"
          data-sidebar-clear
          class="inline-flex shrink-0 items-center gap-1 rounded-full border-2 border-neutral-900 bg-white px-2 py-1 text-xs font-bold uppercase tracking-wide text-neutral-900 transition hover:bg-primary-light hover:border-primary hover:text-primary focus:outline-none focus:ring-2 focus:ring-primary/20 disabled:cursor-not-allowed disabled:opacity-40"
          disabled
        >
          <span class="hidden sm:inline">{filtersMessages.sidebarClear}</span>
          <svg class="h-3.5 w-3.5" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 011.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
              clip-rule="evenodd"
            />
          </svg>
        </button>
      </div>
      <div
        class="mt-3 flex flex-wrap gap-2"
        data-sidebar-active-filters
        data-empty-message={filtersMessages.sidebarEmpty}
        aria-live="polite"
      >
        <span class="text-xs text-neutral-500">{filtersMessages.sidebarEmpty}</span>
      </div>
    </div>

    <!-- Category Filters - Estilo Editorial -->
    <div>
      <h3 class="mb-2 font-serif text-base font-bold text-neutral-950">{filtersMessages.category}</h3>
      <div class="space-y-1.5">
        <button
          data-category="all"
          class="category-btn-sidebar category-btn-active w-full border-thick border-primary bg-primary px-3 py-2 text-left text-sm font-bold text-white shadow-illustration transition-all hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          aria-pressed="true"
        >
          {filtersMessages.allCategories}
        </button>
        {categories.map((cat) => (
            <button
              data-category={cat}
              class="category-btn-sidebar w-full border-thick border-neutral-900 bg-white px-3 py-2 text-left text-sm font-bold text-neutral-900 shadow-illustration transition-all hover:border-primary hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
              aria-pressed="false"
            >
              {cat}
            </button>
        ))}
      </div>
    </div>

    <!-- Dropdown Filters -->
    <div class="space-y-3">
      <MultiSelectDropdown
        label={filtersMessages.tools}
        name="tools"
        options={toolOptions}
        id="tools-dropdown"
      />

      <MultiSelectDropdown
        label={filtersMessages.level}
        name="level"
        options={levelOptions}
        id="level-dropdown"
      />

      <!-- Location Dropdown (inline for custom labels) -->
      <div class="relative" data-dropdown="dropdown-location">
        <button
          type="button"
          data-dropdown-trigger
          class="w-full flex items-center justify-between border-thick border-neutral-900 bg-white px-4 py-3 text-left text-sm font-bold text-neutral-950 shadow-illustration transition-all hover:border-primary hover:bg-primary-light focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          aria-expanded="false"
        >
          <span class="flex-1">{filtersMessages.location}</span>
          <div class="flex items-center gap-2">
            <span data-count class="text-xs font-semibold text-primary"></span>
            <svg
              data-chevron
              class="h-4 w-4 transition-transform text-neutral-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </div>
        </button>
        <div
          data-dropdown-content
          class="absolute left-0 right-0 top-full z-50 mt-1 hidden max-h-64 overflow-y-auto border-thick border-neutral-900 bg-white shadow-xl"
        >
          <div class="p-2 space-y-1">
            {locationOptions.map((option) => (
              <label class="flex items-center gap-2 cursor-pointer p-2 transition-colors hover:bg-primary-lightest">
                <input
                  type="checkbox"
                  name="location"
                  value={option.value}
                  class="h-4 w-4 shrink-0 border-neutral-300 text-primary focus:ring-primary"
                  data-dropdown-checkbox
                />
                <span class="text-sm font-semibold text-neutral-950">{option.label}</span>
              </label>
            ))}
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons - Footer Fixo (fora do scroll) -->
  <div class="shrink-0 border-t-4 border-neutral-900 bg-white p-4 space-y-2">
    <Button
      id="apply-filters-sidebar"
      type="button"
      variant="primary"
      size="md"
      class="w-full disabled:opacity-50 disabled:cursor-not-allowed"
    >
      {filtersMessages.apply}
    </Button>
    <Button
      id="clear-filters-sidebar"
      type="button"
      variant="outline"
      size="md"
      class="w-full"
    >
      {filtersMessages.clear}
    </Button>
  </div>
</aside>

<script>
  import { FiltersSidebarController } from '../lib/filters/sidebar-controller';

  // Wait for DOM to be ready (including MultiSelectDropdown initialization)
  document.addEventListener('DOMContentLoaded', () => {
    // Gather all required DOM elements
    const sidebar = document.getElementById('filters-sidebar') as HTMLElement;
    const searchInput = document.getElementById('job-search-sidebar') as HTMLInputElement;
    const categoryButtons = Array.from(
      document.querySelectorAll<HTMLButtonElement>('.category-btn-sidebar')
    );
    const applyBtn = document.getElementById('apply-filters-sidebar') as HTMLButtonElement;
    const clearBtn = document.getElementById('clear-filters-sidebar') as HTMLButtonElement;
    const summaryClearBtn = document.querySelector('[data-sidebar-clear]') as HTMLButtonElement | null;

    // Checkbox groups
    const levelCheckboxes = Array.from(
      document.querySelectorAll<HTMLInputElement>('input[name="level"]')
    );
    const toolsCheckboxes = Array.from(
      document.querySelectorAll<HTMLInputElement>('input[name="tools"]')
    );
    const locationCheckboxes = Array.from(
      document.querySelectorAll<HTMLInputElement>('input[name="location"]')
    );

    // Initialize controller with all elements
    new FiltersSidebarController({
      sidebar,
      overlay: null,
      toggleBtn: null,
      closeBtn: null,
      searchInput,
      categoryButtons,
      applyBtn,
      clearBtn,
      checkboxGroups: {
        level: levelCheckboxes,
        tools: toolsCheckboxes,
        location: locationCheckboxes,
      },
    });

    summaryClearBtn?.addEventListener('click', () => clearBtn?.click());
  });
</script>
