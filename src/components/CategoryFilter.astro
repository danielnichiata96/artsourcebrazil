---
import { slugify } from '../lib/jobs';

export interface Props {
  categories: string[];
  tags?: string[];
}

const { categories = [], tags = [] } = Astro.props as Props;
const currentPath = Astro.url.pathname;
---

<div class="mb-8 space-y-4">
  <!-- Category buttons -->
  <div class="flex flex-wrap items-center justify-center gap-2">
    <a
      href="/"
      class:list={[
        'rounded-full px-3 py-1.5 text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500',
        currentPath === '/'
          ? 'bg-blue-600 text-white'
          : 'bg-gray-200 text-gray-700 hover:bg-gray-300',
      ]}>All</a
    >
    {
      categories.map((cat) => {
        const slug = slugify(cat);
        const href = `/category/${slug}`;
        const isActive = currentPath === href;
        return (
          <a
            href={href}
            class:list={[
              'rounded-full px-3 py-1.5 text-sm font-medium transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500',
              isActive
                ? 'bg-blue-600 text-white'
                : 'bg-gray-200 text-gray-700 hover:bg-gray-300',
            ]}
          >
            {cat}
          </a>
        );
      })
    }
  </div>

  <!-- Search input -->
  <div class="flex justify-center">
    <input
      id="job-search"
      type="search"
      inputmode="search"
      placeholder="Search title, company or tags"
      class="w-full max-w-2xl rounded-lg border border-gray-300 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
    />
  </div>

  <!-- Tag chips -->
  {
    tags.length > 0 && (
      <div class="flex flex-wrap items-center justify-center gap-2">
        {tags.map((t) => (
          <button
            class="tag-btn rounded-full bg-gray-200 px-3 py-1.5 text-sm font-medium text-gray-700 hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500"
            data-tag={t}
          >
            {t}
          </button>
        ))}
      </div>
    )
  }
</div>

<script>
  const params = new URLSearchParams(location.search);
  let q = params.get('q') || '';
  let selectedTags = (params.get('tags') || '').split(',').filter(Boolean);

  const container = document.querySelector('[data-jobs]');
  const items = Array.from(container ? container.children : []);
  const tagButtons = Array.from(document.querySelectorAll('.tag-btn'));
  const searchInput = document.getElementById('job-search');

  function reflectUI() {
    // tags
    const setSel = new Set(selectedTags.map((t) => t.toLowerCase()));
    tagButtons.forEach((btn) => {
      const active = setSel.has((btn.dataset.tag || '').toLowerCase());
      btn.classList.toggle('bg-blue-600', active);
      btn.classList.toggle('text-white', active);
      btn.classList.toggle('bg-gray-200', !active);
      btn.classList.toggle('text-gray-700', !active);
      btn.setAttribute('aria-pressed', String(active));
    });
    // search
    if (searchInput) searchInput.value = q;
  }

  function applyFilters() {
    const qLower = (q || '').toLowerCase();
    const tagsLower = selectedTags.map((t) => t.toLowerCase());

    items.forEach((el) => {
      const tagsStr = (el.getAttribute('data-tags') || '').toLowerCase();
      const text = (el.getAttribute('data-text') || '').toLowerCase();

      const searchPass = !qLower || text.includes(qLower) || tagsStr.includes(qLower);
      const tagsPass =
        tagsLower.length === 0 || tagsLower.every((t) => tagsStr.split(/\s+/).includes(t));

      const show = searchPass && tagsPass;
      el.classList.toggle('hidden', !show);
    });

    // update URL
    if (q) params.set('q', q);
    else params.delete('q');
    if (selectedTags.length) params.set('tags', selectedTags.join(','));
    else params.delete('tags');
    const url = `${location.pathname}${params.toString() ? `?${params.toString()}` : ''}`;
    history.replaceState({}, '', url);

    reflectUI();
  }

  // events
  tagButtons.forEach((btn) => {
    btn.addEventListener('click', () => {
      const t = btn.dataset.tag || '';
      if (!t) return;
      const idx = selectedTags.indexOf(t);
      if (idx >= 0) selectedTags.splice(idx, 1);
      else selectedTags.push(t);
      applyFilters();
    });
  });

  if (searchInput) {
    let to;
    searchInput.addEventListener('input', () => {
      clearTimeout(to);
      to = setTimeout(() => {
        q = searchInput.value || '';
        applyFilters();
      }, 150);
    });
  }

  // Delegate clicks on tags inside job cards
  if (container) {
    container.addEventListener('click', (e) => {
      const target = e.target;
      if (target && target.getAttribute && target.hasAttribute('data-tag')) {
        const t = target.getAttribute('data-tag') || '';
        if (!t) return;
        const idx = selectedTags.indexOf(t);
        if (idx >= 0) selectedTags.splice(idx, 1);
        else selectedTags.push(t);
        applyFilters();
      }
    });
  }

  // init on load from URL
  reflectUI();
  applyFilters();
</script>
