---
import { getMessages } from '../lib/i18n';
import type { Locale } from '../lib/i18n';

export interface Props {
  url: string;
  title: string;
  className?: string;
  locale?: Locale;
}

const { url, title, className, locale = 'pt-BR' } = Astro.props;
const messages = getMessages(locale);
const shareMessages = messages.job.share;

const shareLinks = {
  twitter: `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`,
  linkedin: `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`,
  whatsapp: `https://api.whatsapp.com/send?text=${encodeURIComponent(`${title} ${url}`)}`,
};
---

<div class:list={['flex items-center gap-4', className]}>
  <p class="text-sm font-bold uppercase tracking-wide text-ink">{shareMessages.label}</p>
  <div class="flex items-center gap-3">
    <a
      href={shareLinks.twitter}
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex h-12 w-12 items-center justify-center rounded-none border-2 border-ink bg-white text-ink shadow-hard-sm transition-all hover:bg-primary hover:text-ink hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] focus:outline-none focus:ring-2 focus:ring-primary/30"
      aria-label={shareMessages.twitter}
      title={shareMessages.twitter}
    >
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M3 3l18 18M21 3L3 21"/>
      </svg>
    </a>
    <a
      href={shareLinks.linkedin}
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex h-12 w-12 items-center justify-center rounded-none border-2 border-ink bg-white text-ink shadow-hard-sm transition-all hover:bg-brazil-blue hover:text-white hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] focus:outline-none focus:ring-2 focus:ring-brazil-blue/30"
      aria-label={shareMessages.linkedin}
      title={shareMessages.linkedin}
    >
      <span class="font-display font-extrabold text-base leading-none">in</span>
    </a>
    <a
      href={shareLinks.whatsapp}
      target="_blank"
      rel="noopener noreferrer"
      class="inline-flex h-12 w-12 items-center justify-center rounded-none border-2 border-ink bg-white text-ink shadow-hard-sm transition-all hover:bg-brazil-green hover:text-white hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] focus:outline-none focus:ring-2 focus:ring-brazil-green/30"
      aria-label={shareMessages.whatsapp}
      title={shareMessages.whatsapp}
    >
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <rect x="7" y="3" width="10" height="18" rx="2" />
        <circle cx="12" cy="6" r="0.5" />
        <path d="M10 17h4" />
      </svg>
    </a>
    <button
      id="copy-link-button"
      type="button"
      class="inline-flex h-12 w-12 items-center justify-center rounded-none border-2 border-ink bg-white text-ink shadow-hard-sm transition-all hover:bg-ink hover:text-paper hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] focus:outline-none focus:ring-2 focus:ring-ink/30"
      aria-label={shareMessages.copyLink}
      title={shareMessages.copyLink}
    >
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
        <path d="M10 13a5 5 0 007.07 0l1.41-1.41a5 5 0 000-7.07 5 5 0 00-7.07 0L10.7 6.22" />
        <path d="M13.3 17.78L12 19.1a5 5 0 01-7.07 0 5 5 0 010-7.07L6.34 10a5 5 0 017.07 0" />
      </svg>
    </button>
  </div>
</div>

<script>
  /**
   * Progressive enhancement clipboard copy with 3-tier fallback strategy
   * Tier 1: Modern Clipboard API (Chrome 63+, Firefox 53+, Safari 13.1+)
   * Tier 2: execCommand fallback (IE11, older Safari)
   * Tier 3: Manual copy with temporary input field (universal fallback)
   */
  document.getElementById('copy-link-button')?.addEventListener('click', async () => {
    const button = document.getElementById('copy-link-button') as HTMLButtonElement | null;
    if (!button) return;

    const url = window.location.href;
    let success = false;
    
    // Tier 1: Try modern Clipboard API
    try {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        await navigator.clipboard.writeText(url);
        success = true;
      }
    } catch (err) {
      console.warn('Clipboard API failed, trying fallback:', err);
    }
    
    // Tier 2: Try execCommand fallback for older browsers
    if (!success) {
      try {
        const textArea = document.createElement('textarea');
        textArea.value = url;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        textArea.style.top = '-9999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        const successful = document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (successful) {
          success = true;
        }
      } catch (err) {
        console.warn('execCommand fallback failed:', err);
      }
    }
    
    // Tier 3: Manual copy fallback with better UX than alert
    if (!success) {
      try {
        const input = document.createElement('input');
        input.type = 'text';
        input.value = url;
        input.readOnly = true;
        input.style.position = 'fixed';
        input.style.left = '50%';
        input.style.top = '50%';
        input.style.transform = 'translate(-50%, -50%)';
        input.style.width = '80%';
        input.style.maxWidth = '500px';
        input.style.padding = '12px';
        input.style.fontSize = '14px';
        input.style.border = '2px solid #298639';
        input.style.borderRadius = '8px';
        input.style.zIndex = '9999';
        input.style.backgroundColor = 'white';
        
        const overlay = document.createElement('div');
        overlay.style.position = 'fixed';
        overlay.style.top = '0';
        overlay.style.left = '0';
        overlay.style.width = '100%';
        overlay.style.height = '100%';
        overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
        overlay.style.zIndex = '9998';
        
        document.body.appendChild(overlay);
        document.body.appendChild(input);
        input.focus();
        input.select();
        
        // Close on click outside or after 5 seconds
        const cleanup = () => {
          document.body.removeChild(input);
          document.body.removeChild(overlay);
        };
        
        overlay.addEventListener('click', cleanup);
        setTimeout(cleanup, 5000);
        
        console.info('Manual copy fallback activated - please copy the URL manually');
        return; // Skip success feedback
      } catch (err) {
        console.error('All copy methods failed:', err);
        alert(`Unable to copy automatically. Please copy this link manually:\n\n${url}`);
        return;
      }
    }
    
    // Show success feedback
    if (success) {
      const originalHTML = button.innerHTML;
      button.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6L9 17l-5-5"/></svg>';
      button.classList.remove('bg-white', 'text-ink');
      button.classList.add('bg-brazil-green', 'text-white');
      
      setTimeout(() => {
        button.innerHTML = originalHTML;
        button.classList.remove('bg-brazil-green', 'text-white');
        button.classList.add('bg-white', 'text-ink');
      }, 2000);
    }
  });
</script>
