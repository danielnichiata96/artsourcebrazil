---
import type { Job } from '../lib/jobs';
import { slugify } from '../lib/jobs';
import { getLocationLabel } from '../lib/location';
import { formatSalaryRange } from '../lib/salary';

export interface Props {
  job: Job;
}

const { job, ...rest } = Astro.props;

const timeAgo = (dateStr: string) => {
    const days = Math.floor((new Date().getTime() - new Date(dateStr).getTime()) / 86400000);
    if (days === 0) return "TODAY";
    if (days === 1) return "YESTERDAY";
    return `${days}D AGO`;
};

const salary = formatSalaryRange(job.salary);
const isNew = (new Date().getTime() - new Date(job.postedDate).getTime()) < (3 * 86400000);
// 4-Pillar Category Colors (Canvas Design System)
const categoryAccents: Record<string, string> = {
    'Engineering & Code': 'bg-accent-purple',  // Purple - Tech/Engineering
    'Art & Animation': 'bg-accent-pink',       // Pink/Orange - Art/Creative
    'Design & Product': 'bg-accent-teal',      // Teal - Design
    'Production': 'bg-accent-lime',            // Lime - Production/Management
};

const accentColor = categoryAccents[job.category] ?? 'bg-accent-lime';
const companyLogo = job.companyLogo || '/images/company-placeholder.svg';
const jobHref = `/jobs/${job.id}-${slugify(job.jobTitle)}`;
const logoAlt = `${job.companyName} logo`;
---

<article 
    {...rest}
    class="job-card group relative flex flex-col md:flex-row border-2 border-ink bg-white p-0 shadow-hard hover:shadow-none hover:translate-x-[5px] hover:translate-y-[5px] transition-all duration-200"
    data-id={job.id}
    data-category={job.category}
    data-location={job.location.scope}
    data-tags={job.tags.join(',').toLowerCase()}
    data-title={job.jobTitle.toLowerCase()}
    data-company={job.companyName.toLowerCase()}
    data-testid="job-card"
>
    <div class:list={["w-full md:w-4 border-b-2 md:border-b-0 md:border-r-2 border-ink h-4 md:h-auto flex-shrink-0", accentColor]}></div>
    <a href={jobHref} class="flex-1 flex flex-col md:flex-row cursor-pointer focus-visible:outline-none" aria-label={`${job.jobTitle} na ${job.companyName}`}>
        <div class="flex-1 p-6 flex flex-col justify-between">
            <div>
                <div class="flex items-start justify-between gap-4 mb-3">
                    <div class="flex items-center gap-4">
                        <div class="h-14 w-14 border-2 border-ink bg-white shadow-hard-sm flex items-center justify-center">
                            <img src={companyLogo} alt={logoAlt} loading="lazy" class="h-12 w-12 object-contain" />
                        </div>
                        <div>
                            <h3 class="font-display text-xl font-bold leading-tight group-hover:text-stone-600 transition-colors">{job.jobTitle}</h3>
                            <p class="text-base font-medium text-stone-500 mt-1">{job.companyName}</p>
                        </div>
                    </div>
                    {isNew && <span class="border-2 border-ink bg-accent-lime px-2 py-0.5 text-xs font-bold uppercase shadow-[2px_2px_0px_0px_#000]">New</span>}
                </div>
                <div class="flex flex-wrap gap-3 mt-4 text-xs font-bold uppercase tracking-wider text-stone-500">
                    <span class="flex items-center gap-1 text-ink">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        {getLocationLabel(job.location.scope)}
                    </span>
                    {job.contractType && (
                        <span class="flex items-center gap-1 text-ink">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            {job.contractType}
                        </span>
                    )}
                    {salary && <span class="text-emerald-700 bg-emerald-100 px-1 border border-emerald-200">{salary}</span>}
                </div>
            </div>
            <div class="mt-6 flex flex-wrap gap-2 relative z-10">
                {/* Category badge as first tag with color */}
                <span class:list={["border-2 border-ink px-2 py-1 text-xs font-bold uppercase shadow-[2px_2px_0px_0px_#000]", accentColor, "text-ink"]}>
                    {job.category}
                </span>
                {/* Regular tags without hover effect */}
                {job.tags.map(tag => <span class="border border-ink bg-white px-2 py-1 text-xs font-bold uppercase shadow-[2px_2px_0px_0px_#e5e5e5]">{tag}</span>)}
            </div>
        </div>
        <div class="p-6 pt-0 md:pt-6 md:border-l-2 md:border-ink flex flex-row md:flex-col items-center md:items-end justify-between md:justify-center gap-4 bg-stone-50 md:bg-transparent">
            <time class="text-xs font-bold text-stone-400 uppercase tracking-widest">{timeAgo(job.postedDate)}</time>
            <div class="hidden md:flex w-10 h-10 border-2 border-ink rounded-full items-center justify-center group-hover:bg-ink group-hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </div>
        </div>
    </a>
</article>
