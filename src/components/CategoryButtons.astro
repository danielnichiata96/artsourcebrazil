---
// CategoryButtons component - Active filters for job categories
export interface Props {
  categories: string[];
}

const { categories = [] } = Astro.props as Props;

// Map categories to emoji icons
const categoryIcons: Record<string, string> = {
  'Game Dev': 'ðŸŽ®',
  '3D & Animation': 'ðŸŽ¨',
  'Design (UI/UX)': 'ðŸŽ¯',
};
---

<nav class="relative z-0 mb-8 flex flex-wrap justify-center gap-3" aria-label="Filter by category">
  <!-- All Jobs button -->
  <button
    data-category="all"
    class="category-btn category-btn-active rounded-full border-2 border-primary bg-primary px-6 py-3 text-base font-semibold text-white transition-all duration-200 hover:scale-105 hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
    aria-pressed="true"
  >
    All Jobs
  </button>

  {
    categories.map((cat) => {
      const icon = categoryIcons[cat] || 'ðŸ“‹';
      return (
        <button
          data-category={cat}
          class="category-btn rounded-full border-2 border-neutral-200 bg-background-paper px-6 py-3 text-base font-semibold text-neutral-700 transition-all duration-200 hover:scale-105 hover:border-neutral-300 hover:shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2"
          aria-pressed="false"
        >
          <span class="mr-2" aria-hidden="true">
            {icon}
          </span>
          {cat}
        </button>
      );
    })
  }
</nav>

<script>
  import { validateFilterUpdate, validateCategory, type PartialFilterState } from '../lib/validation/filter-schema';

  let selectedCategory: string = 'all';

  const categoryButtons = Array.from(
    document.querySelectorAll<HTMLButtonElement>('.category-btn')
  );

  function updateCategoryUI(): void {
    categoryButtons.forEach((btn) => {
      if (!btn) return;
      
      const cat = btn.dataset.category || '';
      const isActive = cat === selectedCategory;

      if (isActive) {
        btn.classList.add('category-btn-active', 'bg-primary', 'text-white', 'border-primary');
        btn.classList.remove('bg-background-paper', 'text-neutral-700', 'border-neutral-200');
      } else {
        btn.classList.remove('category-btn-active', 'bg-primary', 'text-white', 'border-primary');
        btn.classList.add('bg-background-paper', 'text-neutral-700', 'border-neutral-200');
      }
      btn.setAttribute('aria-pressed', String(isActive));
    });
  }

  function dispatchChange(partial: PartialFilterState): void {
    try {
      // Validate before dispatching
      const validatedData = validateFilterUpdate(partial);
      if (!validatedData) {
        console.warn('[CategoryButtons] Invalid filter data, skipping dispatch');
        return;
      }
      
      window.dispatchEvent(new CustomEvent('jobfilters:change', { detail: validatedData }));
    } catch (error) {
      console.error('[CategoryButtons] Error dispatching change:', error);
    }
  }

  // Category button click handlers -> update global state
  categoryButtons.forEach((btn) => {
    if (!btn) return;
    
    btn.addEventListener('click', () => {
      const cat = validateCategory(btn.dataset.category);
      selectedCategory = cat;
      updateCategoryUI(); // Update UI immediately
      // Reset search value in UI; global orchestrator will handle filtering
      const searchInput = document.getElementById('job-search') as HTMLInputElement | null;
      if (searchInput) searchInput.value = '';
      dispatchChange({ category: selectedCategory, search: '' });
    });
  });

  // Listen for applied state to keep UI in sync (e.g., on reload via URL params)
  window.addEventListener('jobfilters:applied', (e: Event) => {
    try {
      const customEvent = e as CustomEvent<PartialFilterState>;
      const detail = customEvent.detail || {};
      if (detail.category) {
        selectedCategory = validateCategory(detail.category);
        updateCategoryUI();
      }
    } catch (error) {
      console.error('[CategoryButtons] Error syncing state:', error);
    }
  });

  // Initial UI sync
  updateCategoryUI();
</script>
