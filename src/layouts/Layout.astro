---
import { getAbsoluteLocaleUrl } from 'astro:i18n';
import Navbar from '../components/ui/Navbar.astro';
import Button from '../components/ui/Button.astro';
import Link from '../components/ui/Link.astro';
import type { Locale, Messages } from '../lib/i18n';
import { defaultLocale, getMessages } from '../lib/i18n';

interface SEO {
  title: string;
  description: string;
  image?: string;
  url?: string;
}

export interface Props {
  seo: SEO;
  noindex?: boolean;
  locale?: Locale;
}

const { seo, noindex = false, locale: propsLocale } = Astro.props as { seo: SEO; noindex?: boolean; locale?: Locale };

const site = Astro.site ?? new URL('http://localhost:4321');
const canonicalUrl = new URL(Astro.url.pathname, site).href;
const ogImage = new URL(seo.image ?? '/images/artsource-brazil-logo.svg', site).href;
const plausibleDomain = import.meta.env.PUBLIC_PLAUSIBLE_DOMAIN as string | undefined;

// Use passed locale or detect from Astro context
const locale = (propsLocale ?? Astro.currentLocale ?? defaultLocale) as Locale;
const messages = getMessages(locale);

// Generate hreflang alternate URLs using Astro i18n helper
// We need to get the current relative path without locale prefix to generate alternates
const currentPath = Astro.url.pathname;
const pathWithoutLocale = currentPath.startsWith('/en/') ? currentPath.replace('/en/', '') : currentPath.replace(/^\/en$/, '');

const hreflangs = {
  'pt-BR': getAbsoluteLocaleUrl('pt-BR', pathWithoutLocale),
  'en': getAbsoluteLocaleUrl('en', pathWithoutLocale),
};

const withLocale = (href: string) => {
  if (!href || href.startsWith('#') || href.startsWith('http')) return href;
  // If it's an absolute path, we can use getAbsoluteLocaleUrl or just prepend locale
  // But for internal links, we usually want relative.
  // Let's keep simple logic for now or use getRelativeLocaleUrl if we import it.
  const baseHref = href.startsWith('/') ? href : `/${href}`;
  return locale === 'en' ? `/en${baseHref}` : baseHref;
};
---

<html lang={locale}>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width" />
    <meta name="generator" content={Astro.generator} />
    
    <!-- Fonts: Space Grotesk & Public Sans -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <title>{seo.title}</title>
    <meta name="description" content={seo.description} />
    <link rel="canonical" href={canonicalUrl} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}
    
    <!-- hreflang tags for international SEO -->
    <link rel="alternate" hreflang="pt-BR" href={hreflangs['pt-BR']} />
    <link rel="alternate" hreflang="en" href={hreflangs['en']} />
    <link rel="alternate" hreflang="x-default" href={hreflangs['pt-BR']} />

    <!-- Open Graph -->
    <meta property="og:type" content="website" />
    <meta property="og:title" content={seo.title} />
    <meta property="og:description" content={seo.description} />
    <meta property="og:url" content={canonicalUrl} />
    <meta property="og:image" content={ogImage} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={seo.title} />
    <meta name="twitter:description" content={seo.description} />
    <meta name="twitter:image" content={ogImage} />

    <slot name="head" />
    <style>
        /* Base Setup & Texture */
        body {
            background-color: #f4f3f0;
            color: #1a1918;
            /* Dot pattern background */
            background-image: radial-gradient(#1a1918 0.5px, transparent 0.5px);
            background-size: 24px 24px;
        }

        /* Noise Overlay for "Paper" Feel */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 50;
            opacity: 0.06;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
        }
        
        /* Custom Checkbox */
        .studio-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid #1a1918;
            background: white;
            display: grid;
            place-content: center;
            transition: all 0.2s;
        }
        .studio-checkbox::before {
            content: "";
            width: 0.65rem;
            height: 0.65rem;
            background: #1a1918;
            transform: scale(0);
            transition: 0.2s transform ease-in-out;
        }
        .studio-checkbox:checked::before {
            transform: scale(1);
        }
        .studio-checkbox:checked {
            background: #F7DD00; /* Brazil Yellow accent on check */
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Staggered Animation Delays */
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
    </style>
  <!-- Vercel Web Analytics (no-code, cookie-free). Load only in production to avoid 404s in dev. -->
  {import.meta.env.PROD && <script defer src="/_vercel/insights/script.js"></script>}

    {
      plausibleDomain && (
        <script defer data-domain={plausibleDomain} src="https://plausible.io/js/script.js" />
      )
    }

    <!-- Organization JSON-LD for the whole site -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify({
        '@context': 'https://schema.org',
        '@type': 'Organization',
        name: 'Art Source Brazil',
        url: new URL('/', site).href,
        email: 'artsourcebrazil@gmail.com',
        logo: new URL('/images/artsource-brazil-logo.svg', site).href,
      })}
    />
  </head>
  <body class="min-h-screen flex flex-col font-sans overflow-x-hidden">
    <!-- Global Texture -->
    <div class="noise-overlay"></div>
    <Navbar locale={locale} />

    <main class="flex-grow">
      <slot />

      <!-- Newsletter CTA Section (Prominent) -->
      <div class="container mx-auto mt-16 px-container">
        <div class="relative overflow-hidden border-2 border-ink bg-gradient-to-br from-brazil-yellow to-brazil-green shadow-hard-lg">
          <!-- Background Pattern -->
          <div class="absolute inset-0 opacity-5">
            <div class="absolute inset-0" style="background-image: radial-gradient(#1a1918 1px, transparent 1px); background-size: 20px 20px;"></div>
          </div>
          
          <div class="relative px-6 py-12 sm:px-12 lg:px-16">
            <div class="mx-auto max-w-3xl text-center">
              <!-- Badge -->
              <div class="inline-flex items-center gap-2 border-2 border-ink bg-white px-4 py-1 shadow-hard-sm">
                <span class="text-xs font-bold uppercase tracking-[0.3em] text-ink">{messages.newsletterCta.badge}</span>
              </div>
              
              <!-- Title -->
              <h2 class="mt-6 font-display text-3xl font-bold uppercase tracking-tight text-ink sm:text-4xl">
                {messages.newsletterCta.title}
              </h2>
              
              <!-- Subtitle -->
              <p class="mt-4 text-base text-neutral-800 sm:text-lg">
                {messages.newsletterCta.subtitle}
              </p>
              
              <!-- Benefits -->
              <div class="mt-6 flex flex-col gap-2 text-left sm:flex-row sm:justify-center sm:gap-6">
                {messages.newsletterCta.benefits.map((benefit) => (
                  <p class="flex items-center gap-2 text-sm font-semibold text-ink">
                    <span class="text-brazil-green">{benefit.split(' ')[0]}</span>
                    <span>{benefit.substring(benefit.indexOf(' ') + 1)}</span>
                  </p>
                ))}
              </div>
              
              <!-- Form -->
              <form
                action={import.meta.env.PUBLIC_NEWSLETTER_SUBSCRIBE_URL}
                method="post"
                target="_blank"
                class="mt-8 flex flex-col items-center gap-3 sm:flex-row sm:justify-center"
              >
                <input
                  type="email"
                  name="email"
                  required
                  placeholder={messages.newsletterCta.placeholder}
                  class="w-full max-w-sm rounded-none border-2 border-ink bg-white px-4 py-3 text-ink shadow-sm transition-all focus:border-ink focus:shadow-hard focus:ring-0"
                />
                <input type="hidden" name="tag" value="artsource-brazil-cta" />
                <Button 
                  type="submit" 
                  class="w-full sm:w-auto rounded-none border-2 border-ink bg-ink text-paper shadow-hard hover:bg-brazil-blue hover:text-white hover:shadow-none hover:translate-x-[2px] hover:translate-y-[2px] transition-all"
                >
                  {messages.newsletterCta.button}
                </Button>
              </form>
              
              <!-- Disclaimer -->
              <p class="mt-4 text-xs text-neutral-700">
                {messages.newsletter.disclaimer}
              </p>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer class="mt-16 border-t-2 border-ink bg-paper py-12">
      <div class="mx-auto flex max-w-7xl flex-col gap-10 px-4 sm:px-6 lg:px-8 text-ink">
        <!-- CTA Section -->
        <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between border-b-2 border-ink pb-8">
          <div class="max-w-2xl space-y-2">
            <p class="font-display text-3xl uppercase tracking-tight">{messages.footer.ctaTitle}</p>
            <p class="text-sm sm:text-base text-neutral-600">{messages.footer.ctaSubtitle}</p>
          </div>
          <Button
            href={withLocale('/post-a-job')}
            class="rounded-none border-ink bg-primary text-ink shadow-hard hover:bg-brazil-blue hover:text-white"
          >
            {messages.footer.ctaButton}
          </Button>
        </div>

        <!-- 4 Columns -->
        <div class="grid gap-8 sm:grid-cols-2 lg:grid-cols-4">
          <!-- Column 1: Explorar Vagas -->
          <div class="space-y-3">
            <p class="text-xs font-bold uppercase tracking-[0.3em] text-neutral-500">{messages.footer.columns.jobs.title}</p>
            <div class="flex flex-col gap-2 text-sm font-semibold">
              {messages.footer.columns.jobs.links.map((link) => (
                <Link href={withLocale(link.href)} variant="muted">{link.label}</Link>
              ))}
              <Link 
                href={withLocale(messages.footer.columns.jobs.viewAll.href)} 
                variant="muted"
                class="text-brazil-blue hover:text-ink font-bold"
              >
                {messages.footer.columns.jobs.viewAll.label} â†’
              </Link>
            </div>
          </div>

          <!-- Column 2: Comunidade & Recursos -->
          <div class="space-y-3">
            <p class="text-xs font-bold uppercase tracking-[0.3em] text-neutral-500">{messages.footer.columns.community.title}</p>
            <div class="flex flex-col gap-2 text-sm font-semibold">
              {messages.footer.columns.community.links.map((link) => (
                <Link href={withLocale(link.href)} variant="muted">{link.label}</Link>
              ))}
            </div>
          </div>

          <!-- Column 3: Sobre o Art Source -->
          <div class="space-y-3">
            <p class="text-xs font-bold uppercase tracking-[0.3em] text-neutral-500">{messages.footer.columns.about.title}</p>
            <div class="flex flex-col gap-2 text-sm font-semibold">
              {messages.footer.columns.about.links.map((link) => (
                <Link href={withLocale(link.href)} variant="muted">{link.label}</Link>
              ))}
            </div>
          </div>

          <!-- Column 4: Social -->
          <div class="space-y-3">
            <p class="text-xs font-bold uppercase tracking-[0.3em] text-neutral-500">{messages.footer.columns.social.title}</p>
            <div class="flex flex-col gap-2 text-sm font-semibold">
              {messages.footer.columns.social.links.map((link) => (
                <Link 
                  href={link.href} 
                  target="_blank"
                  rel="noopener noreferrer"
                  variant="muted"
                >
                  {link.label}
                </Link>
              ))}
            </div>
            <!-- Email Contact -->
            <div class="pt-2 border-t border-neutral-300">
              <p class="text-xs uppercase tracking-wider text-neutral-500 mb-1">Email</p>
              <Link
                href="mailto:artsourcebrazil@gmail.com"
                variant="muted"
                class="text-xs"
              >
                artsourcebrazil@gmail.com
              </Link>
            </div>
          </div>
        </div>

        <!-- Copyright -->
        <div class="flex flex-col gap-2 border-t-2 border-dashed border-ink pt-4 text-sm text-neutral-600 sm:flex-row sm:items-center sm:justify-between">
          <p>&copy; {new Date().getFullYear()} Art Source Brazil. {messages.footer.copyright}</p>
          <span class="text-xs uppercase tracking-[0.4em] text-neutral-500">{messages.footer.signature}</span>
        </div>
      </div>
    </footer>
  </body>
</html>
